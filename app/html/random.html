<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Smoothed Randomness Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: system-ui, sans-serif;
        background: #0e0e10;
        color: #e0e0e0;
      }
      h1 {
        color: #80dfff;
        font-weight: 500;
      }
      #controls {
        margin-bottom: 20px;
      }
      input[type="range"] {
        width: 300px;
      }
      canvas {
        width: 100%;
        background: #1a1a1d;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        padding: 10px;
      }

      button {
        background-color: #80dfff;
        color: #0e0e10;
        border: none;
        border-radius: 8px;
        padding: 5px 10px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #60bfff;
      }
    </style>
  </head>
  <body>
    <h1>Smoothed Random Value Simulation</h1>

    <div id="controls">
      <label for="variability"
        >Variability: <span id="varLabel">0.5</span></label
      ><br />
      <input
        type="range"
        id="variability"
        min="0"
        max="1"
        step="0.01"
        value="0.5"
      />
      <button id="runBtn">Run Simulation</button>
    </div>

    <canvas id="chart"></canvas>

    <script>
      // --- Core Simulation Logic ---
      let randomValues = new Map();
      let variability = 0.5;

      function getRandomValue(chance, id) {
        if (!randomValues.has(id))
          randomValues.set(id, variability + Math.random() * (1 - variability));

        let value = randomValues.get(id);
        const minus = chance + Math.random() * chance;
        value -= minus;

        if (value <= 0) {
          randomValues.set(id, variability + Math.random() * (1 - variability));
          return true;
        } else {
          // Keep decaying normally
          randomValues.set(id, value);
          return false;
        }
      }

      function rateGetRandomValueFunc(ids = 101, loop = 5000) {
        randomValues.clear();
        const results = [];
        for (let i = 0; i < ids; i++) {
          const chance = parseFloat((i * 0.01).toFixed(2));
          let result = 0;
          const resultArray = [];
          for (let j = 0; j < loop; j++) {
            if (getRandomValue(chance, i)) {
              result++;
              resultArray.push(1);
            } else {
              resultArray.push(0);
            }
          }
          result /= loop;
          result = parseFloat(result.toFixed(5));
          results.push({ id: i, chance, result, resultArray });
        }
        console.clear();
        console.log(`Simulation results:\n`, results);
        return results;
      }

      // --- Chart Setup ---
      const ctx = document.getElementById("chart").getContext("2d");
      let chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Observed Success Rate",
              data: [],
              borderColor: "#80dfff",
              borderWidth: 2,
              tension: 0.2,
              pointRadius: 0,
            },
            {
              label: "Ideal (y = x)",
              data: [],
              borderColor: "#ff6666",
              borderDash: [5, 5],
              borderWidth: 1.5,
              tension: 0.2,
              pointRadius: 0,
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: { display: true, text: "Chance" },
              ticks: { color: "#ccc" },
            },
            y: {
              title: { display: true, text: "Average Success Rate" },
              min: 0,
              max: 1,
              ticks: { color: "#ccc" },
            },
          },
          plugins: {
            legend: {
              labels: { color: "#eee" },
            },
          },
        },
      });

      // --- Runner ---
      function runSimulation() {
        variability = parseFloat(document.getElementById("variability").value);
        document.getElementById("varLabel").textContent =
          variability.toFixed(2);

        const data = rateGetRandomValueFunc(101, 5000);
        const chances = data.map((d) => d.chance.toFixed(2));
        const results = data.map((d) => d.result.toFixed(4));
        const ideal = data.map((d) => d.chance);

        chart.data.labels = chances;
        chart.data.datasets[0].data = results;
        chart.data.datasets[1].data = ideal;
        chart.update();
      }

      document
        .getElementById("runBtn")
        .addEventListener("click", runSimulation);
      document.getElementById("variability").addEventListener("input", () => {
        document.getElementById("varLabel").textContent = parseFloat(
          document.getElementById("variability").value,
        ).toFixed(2);
      });

      // Run on load
      runSimulation();
    </script>
  </body>
</html>
