<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>reload - Editor</title>

        <link rel="stylesheet" href="../css/font-renderer.css" />
        <link
            rel="stylesheet"
            href="../css/themes.css"
            id="themes-stylesheet"
        />
        <link rel="stylesheet" href="../css/style.css" />
        <link rel="stylesheet" href="../css/musicEditor.css" />
        <link rel="stylesheet" href="../css/slider.css" />
        <link rel="stylesheet" href="../css/toolTip.css" />
    </head>
    <body>
        <div class="notification" id="notification"></div>

        <div id="app">
            <div class="container">
                <h2>Album Information</h2>
                <div class="album-info">
                    <div class="field">
                        <label for="name">Name</label>
                        <input type="text" id="name" placeholder="Album name" />
                    </div>

                    <div class="field">
                        <label for="author">Artist</label>
                        <input
                            type="text"
                            id="author"
                            placeholder="Artist name"
                        />
                    </div>

                    <div class="field">
                        <label for="label">Label</label>
                        <input
                            type="text"
                            id="label"
                            placeholder="Record label"
                        />
                    </div>

                    <div class="field">
                        <label for="year">Year</label>
                        <input
                            type="number"
                            id="year"
                            placeholder="Release year"
                        />
                    </div>

                    <div class="field">
                        <label for="genre">Genre</label>
                        <input
                            type="text"
                            id="genre"
                            placeholder="Music genre"
                        />
                    </div>

                    <div class="field">
                        <span mode="10;1" data-slider="albumRating"
                            >Album Rating:
                        </span>
                        <input
                            type="range"
                            class="slider"
                            step=".1"
                            min="0"
                            value="5"
                            max="10"
                            id="albumRating"
                        />
                    </div>

                    <div class="field">
                        <label for="description">Description</label>
                        <input
                            type="text"
                            id="description"
                            placeholder="Album description"
                        />
                    </div>

                    <div class="field">
                        <label for="color">Album Color</label>
                        <input type="color" id="color" value="#AAAAAA" />
                    </div>
                </div>
                <div class="header">
                    <button id="save-button" class="add">Save Changes</button>
                    <button id="load-button">Reload Data</button>
                </div>
            </div>

            <div class="container">
                <h2>Track List</h2>
                <div id="tracks-container" class="track-list">
                    <!-- Tracks will be added here dynamically -->
                </div>

                <div class="actions">
                    <button id="add-track" class="add">Add New Track</button>
                    <button id="sort-tracks">Sort by Title</button>
                </div>
            </div>
        </div>

        <script src="../js/imports.js"></script>
        <script src="../js/css/sliders.js"></script>
        <script src="../js/css/gradientHelper.js"></script>
        <script src="../js/css/notification.js"></script>
        <script src="../js/css/tooltip.js"></script>
        <script>
            // Global variable to store the music data
            let musicData = {
                trackList: [],
                description: {
                    name: "",
                    author: "",
                    label: "",
                    description: "",
                    year: 2024,
                    genre: "",
                    color: "#AAAAAA",
                    rating: 5,
                },
            };

            // DOM elements
            const nameInput = document.getElementById("name");
            const authorInput = document.getElementById("author");
            const labelInput = document.getElementById("label");
            const yearInput = document.getElementById("year");
            const genreInput = document.getElementById("genre");
            const albumRatingSelect = document.getElementById("albumRating");
            const descriptionInput = document.getElementById("description");
            const colorInput = document.getElementById("color");
            const tracksContainer = document.getElementById("tracks-container");
            const addTrackButton = document.getElementById("add-track");
            const sortTracksButton = document.getElementById("sort-tracks");
            const saveButton = document.getElementById("save-button");
            const loadButton = document.getElementById("load-button");
            const notification = document.getElementById("notification");
            let jsonPath = null;

            async function loadSettings() {
                let settings = {
                    theme: { dark: "", light: "" },
                    themeMode: "dark",
                };
                try {
                    let newSettings =
                        (await ipcRenderer.invoke("get-settings")) || {};

                    for (const key in settings) {
                        // saver load
                        if (newSettings && newSettings.hasOwnProperty(key)) {
                            settings[key] = newSettings[key];
                        }
                    }
                } catch (error) {
                    console.error("Error loading settings:", error);
                }

                // Apply settings
                document.body.setAttribute(
                    "theme",
                    settings.theme[settings.themeMode],
                );
            }

            ipcRenderer.on(
                "settings-updated",
                async (event, updatedSettings) => {
                    await loadSettings();

                    let link = document.getElementById("themes-stylesheet");
                    // Force reload by appending timestamp query
                    link.href = `../css/themes.css?ts=${Date.now()}`;
                },
            );

            // Function to load music data from server
            async function loadMusicData() {
                try {
                    loadSettings(); // for theme
                    jsonPath = await fetch("../saves/jsonToLoad.txt").then(
                        (res) => res.text(),
                    );
                    console.log("Loading music data from:", jsonPath);
                    const response = await fetch(jsonPath);
                    if (!response.ok) {
                        throw new Error("Failed to load music data");
                    }

                    musicData = await response.json();

                    await populateForm();
                    if (!musicData.description.name) {
                        musicData.description.name = musicData.name; // this is the folder's name
                        nameInput.value = musicData.description.name;
                    }
                    changeBackGroundColorFromNewAlbum(
                        musicData.description.color,
                    );

                    showNotification("Music data loaded successfully");
                } catch (error) {
                    console.error("Error loading music data:", error);
                    showNotification(
                        "Error loading music data: " + error.message,
                    );
                }
            }

            // Function to populate the form with music data
            function populateForm() {
                const { description } = musicData;

                // Fill album information
                nameInput.value = description.name || "";
                authorInput.value = description.author || "";
                labelInput.value = description.label || "";
                yearInput.value =
                    description.year == ""
                        ? new Date().getFullYear()
                        : description.year;
                genreInput.value = description.genre || "";
                albumRatingSelect.value = description.rating || 5;
                descriptionInput.value = description.description || "";

                // Colors
                colorInput.value = description?.color || "#AAAAAA";

                // Clear existing tracks
                tracksContainer.innerHTML = "";

                // Add tracks
                musicData.trackList.forEach((track, index) => {
                    addTrackToDOM(track, index);
                });
                sController.updateSliders();
            }

            // Function to add a track to the DOM
            function addTrackToDOM(track, index) {
                const trackDiv = document.createElement("div");
                trackDiv.className = "track";
                trackDiv.dataset.index = index;

                trackDiv.innerHTML = `
                <input type="text" class="track-title" value="${track.title || ""}" placeholder="Track title">
                <span mode="10;1" data-slider="track-rating ${index}"></span>
                <input type="range" class="slider" step=".1" min="0" value="5" max="10" id="track-rating ${index}">
                <div class="track-actions">
                    <button class="move-up">↑</button>
                    <button class="move-down">↓</button>
                    <button class="danger remove-track">Remove</button>
                </div>
            `;

                // Add event listeners to the track
                trackDiv
                    .querySelector(".track-title")
                    .addEventListener("input", updateTrackData);
                trackDiv
                    .querySelector(".slider")
                    .addEventListener("change", updateTrackData);
                trackDiv
                    .querySelector(".remove-track")
                    .addEventListener("click", () => removeTrack(trackDiv));
                trackDiv
                    .querySelector(".move-up")
                    .addEventListener("click", () => moveTrack(trackDiv, "up"));
                trackDiv
                    .querySelector(".move-down")
                    .addEventListener("click", () =>
                        moveTrack(trackDiv, "down"),
                    );

                tracksContainer.appendChild(trackDiv);
            }

            // Function to update track data in the musicData object
            function updateTrackData() {
                // Get all track elements
                const trackElements =
                    tracksContainer.querySelectorAll(".track");

                // Create a new array for the track list
                const updatedTracks = [];

                // Loop through track elements and update data
                trackElements.forEach((trackElement) => {
                    const titleInput =
                        trackElement.querySelector(".track-title");
                    const ratingSelect = trackElement.querySelector(".slider");

                    updatedTracks.push({
                        title: titleInput.value,
                        rating: parseInt(ratingSelect.value, 10),
                    });
                });

                // Update the music data
                musicData.trackList = updatedTracks;
            }

            // Function to add a new track
            function addNewTrack() {
                const newTrack = {
                    title: `New Track ${musicData.trackList.length + 1}`,
                    rating: 5,
                };

                musicData.trackList.push(newTrack);
                addTrackToDOM(newTrack, musicData.trackList.length - 1);
                sController.updateSliders();
            }

            // Function to remove a track
            function removeTrack(trackElement) {
                if (confirm("Are you sure you want to remove this track?")) {
                    trackElement.remove();
                    updateTrackData();
                }
            }

            // Function to move a track up or down
            function moveTrack(trackElement, direction) {
                const trackElements = Array.from(
                    tracksContainer.querySelectorAll(".track"),
                );
                const currentIndex = trackElements.indexOf(trackElement);

                if (direction === "up" && currentIndex > 0) {
                    tracksContainer.insertBefore(
                        trackElement,
                        trackElements[currentIndex - 1],
                    );
                } else if (
                    direction === "down" &&
                    currentIndex < trackElements.length - 1
                ) {
                    tracksContainer.insertBefore(
                        trackElements[currentIndex + 1],
                        trackElement,
                    );
                }

                updateTrackData();
            }

            // Function to sort tracks by title
            function sortTracks() {
                // Sort tracks in musicData
                musicData.trackList.sort((a, b) => {
                    const numA = parseInt(a.match(/^\d+/)?.[0], 10) || Infinity;
                    const numB = parseInt(b.match(/^\d+/)?.[0], 10) || Infinity;
                    return numA - numB;
                });

                // Clear and repopulate track container
                tracksContainer.innerHTML = "";
                musicData.trackList.forEach((track, index) => {
                    addTrackToDOM(track, index);
                });

                sController.updateSliders();
                showNotification("Tracks sorted by title");
            }

            // Function to update the album information
            function updateAlbumInfo() {
                musicData.description.name = nameInput.value;
                musicData.description.author = authorInput.value;
                musicData.description.label = labelInput.value;
                musicData.description.year = parseInt(yearInput.value, 10);
                musicData.description.genre = genreInput.value;
                musicData.description.rating = parseInt(
                    albumRatingSelect.value,
                );
                musicData.description.description = descriptionInput.value;
                musicData.description.color = colorInput.value;
            }

            // Function to save music data
            async function saveMusicData() {
                try {
                    saveButton.innerHTML = '<span class="spinner"></span>';
                    saveButton.disabled = true;

                    // Save the latest album and track info before sending
                    updateAlbumInfo();
                    updateTrackData();

                    // Send the updated musicData to the backend
                    try {
                        await fs.writeFileSync(
                            jsonPath,
                            JSON.stringify(musicData, null, 2),
                            "utf8",
                        );
                        ipcRenderer.invoke("changed-json-data");
                    } catch (err) {
                        console.error("Error creating music.json:", err);
                    }

                    showNotification("Music data saved successfully!");
                } catch (error) {
                    console.error("Error saving music data:", error);
                    showNotification(
                        "Error saving music data: " + error.message,
                        "error",
                    );
                } finally {
                    saveButton.innerHTML = "Save Changes";
                    saveButton.disabled = false;
                }
            }

            function updateColor() {
                let r, g, b;
                if (colorInput.value.startsWith("#")) {
                    // Remove the hash and parse the hex
                    let hex = colorInput.value.replace("#", "");
                    if (hex.length === 3) {
                        // Expand shorthand hex (e.g. #abc -> #aabbcc)
                        hex = hex
                            .split("")
                            .map((x) => x + x)
                            .join("");
                    }
                    const intVal = parseInt(hex, 16);
                    const rVal = (intVal >> 16) & 255;
                    const gVal = (intVal >> 8) & 255;
                    const bVal = intVal & 255;
                    [r, b, g] = [rVal, gVal, bVal];
                } else {
                    [r, b, g] = colorInput.value;
                }

                // limit how bright the color can be (to avoid white colors)
                const total = r + g + b;
                const clamp = 0.9 * 765; // 765 = 255 * 3
                if (total > clamp) {
                    const scale = clamp / total;
                    r = Math.round(r * scale);
                    g = Math.round(g * scale);
                    b = Math.round(b * scale);
                }
                r = Math.max(0, Math.min(255, r));
                g = Math.max(0, Math.min(255, g));
                b = Math.max(0, Math.min(255, b)); // always nice to clamp (bc me bad at js)

                colorInput.value = `#${((1 << 24) + (r << 16) + (g << 8) + b)
                    .toString(16)
                    .slice(1)
                    .toUpperCase()}`;
                changeBackGroundColorFromNewAlbum(colorInput.value);
                updateAlbumInfo();
            }

            // Add event listeners
            authorInput.addEventListener("input", updateAlbumInfo);
            labelInput.addEventListener("input", updateAlbumInfo);
            yearInput.addEventListener("input", updateAlbumInfo);
            genreInput.addEventListener("input", updateAlbumInfo);
            albumRatingSelect.addEventListener("change", updateAlbumInfo);
            descriptionInput.addEventListener("input", updateAlbumInfo);
            colorInput.addEventListener("change", updateColor);
            colorInput.addEventListener("input", () => {
                changeBackGroundColorFromNewAlbum(colorInput.value);
            });

            addTrackButton.addEventListener("click", addNewTrack);
            sortTracksButton.addEventListener("click", sortTracks);
            saveButton.addEventListener("click", saveMusicData);
            loadButton.addEventListener("click", loadMusicData);

            // Load music data when the page loads
            document.addEventListener("DOMContentLoaded", loadMusicData);
        </script>
    </body>
</html>
